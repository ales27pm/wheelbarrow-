name: Generate wheelbarrow drawing plans

on:
  push:
    branches: ["**"]
  pull_request:
  workflow_dispatch:

jobs:
  generate-drawings:
    runs-on: ubuntu-22.04
    env:
      DRAWING_OUTPUT_DIR: ${{ github.workspace }}/wheelbarrow_build/drawings
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Cache FreeCAD AppImage payload
        id: cache-freecad
        uses: actions/cache@v4
        with:
          path: .freecad/appimage-1.0.2
          key: ${{ runner.os }}-freecad-1.0.2

      - name: Prepare FreeCAD AppImage
        run: ./setup.sh --prepare-appimage

      - name: Generate 2D drawing exports
        env:
          QT_QPA_PLATFORM: offscreen
        run: |
          set -euo pipefail
          mkdir -p "${DRAWING_OUTPUT_DIR}"
          export FREECADPATH="${FREECAD_APPIMAGE_DIR}/squashfs-root/usr/lib/freecad/lib"
          export LD_LIBRARY_PATH="${FREECAD_APPIMAGE_DIR}/squashfs-root/usr/lib:${LD_LIBRARY_PATH:-}"
          export FREECAD_USER_HOME="${GITHUB_WORKSPACE}/wheelbarrow_build/freecad_user"
          export XDG_RUNTIME_DIR="${GITHUB_WORKSPACE}/wheelbarrow_build/runtime"
          mkdir -p "${FREECAD_USER_HOME}"
          mkdir -p "${XDG_RUNTIME_DIR}"
          chmod 700 "${XDG_RUNTIME_DIR}"

          python_bin="${FREECAD_PYTHON:-${FREECAD_APPIMAGE_DIR}/squashfs-root/usr/bin/python}"
          python_path_hint="${FREECAD_PYTHONPATH:-}"
          if [ -z "${python_path_hint}" ]; then
            for candidate in "${FREECAD_APPIMAGE_DIR}"/squashfs-root/usr/lib/python3.*; do
              if [ -d "${candidate}" ]; then
                python_path_hint="${candidate}/site-packages:${FREECAD_APPIMAGE_DIR}/squashfs-root/usr/lib"
                break
              fi
            done
          fi
          if [ -z "${python_path_hint}" ]; then
            echo "Unable to determine FreeCAD AppImage Python site-packages path" >&2
            exit 1
          fi
          export PYTHONPATH="${python_path_hint}"

          "${python_bin}" \
            "${GITHUB_WORKSPACE}/generate_wheelbarrow_drawings.py" \
            --out "${DRAWING_OUTPUT_DIR}" \
            --paper Tabloid \
            --scale 1.0 \
            --no-titleblock \
            --pdf-backend auto

      - name: Inspect generated drawings
        run: |
          set -euo pipefail
          ls -R "${DRAWING_OUTPUT_DIR}"
          test -f "${DRAWING_OUTPUT_DIR}/all_parts.dxf"
          test -f "${DRAWING_OUTPUT_DIR}/all_parts.svg"
          test -f "${DRAWING_OUTPUT_DIR}/all_parts.pdf"

      - name: Bundle drawing outputs
        run: |
          set -euo pipefail
          mkdir -p wheelbarrow-drawings/raw
          rsync -a --delete "${DRAWING_OUTPUT_DIR}/" wheelbarrow-drawings/raw/
          tar -czf wheelbarrow-drawings/wheelbarrow-drawings.tar.gz -C "${DRAWING_OUTPUT_DIR}" .
          ls -R wheelbarrow-drawings

      - name: Upload drawing artifact
        uses: actions/upload-artifact@v4
        with:
          name: wheelbarrow-drawing-plans
          path: wheelbarrow-drawings
          if-no-files-found: error
